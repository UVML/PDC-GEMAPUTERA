<div id="app">

    <div class="row mb-3">
        <div class="col">
            <h4>{{selectedSukan == "Pilih Sukan" ? "" : selectedSukan.toUpperCase()}}</h5>
        </div>
        <div class="col-auto">

            <select class="form-control-sm" style="width: 200px;" v-model="selectedSukan" @@change="getData()">
                <option disabled selected>Pilih Sukan</option>
                @foreach (var item in ViewBag.SenaraiSukan)
                {
                    <option>@item</option>
                }
            </select>
            <button class="btn btn-outline-primary btn-sm" @@click="simpan()">Simpan</button>
            &nbsp;
            &nbsp;
            <a href="/Home/Index" class="btn btn-outline-secondary btn-sm"><span class="fa-solid fa-arrow-left"
                    title="Kembali"></span></a>
            <button class="btn btn-outline-danger btn-sm" @@click="padam()"><span class="fa-solid fa-trash"
                    title="Padam"></span></button>

        </div>
    </div>



    <span class="tiny text-secondary">Semua adalah wajib kecuali 1) Kategori Permainan, 2) Status Pemain dan 3) Lampiran Surat Pengarah SSM</span>
    <div class="card mb-3">
        <div class="card-header">
            <span class="fa-solid fa-user-tie"></span> <span class="text-primary">Pengurus</span>
        </div>
        <div class="card-body">
            <div class="row mb-1" v-for="(item, index) in getPengurus">
                <div class="col">
                    <div class="table-responsive">

                        @* <table class="table-sm">
                        <tr>
                        <td style="width:15px"><span class="badge bg-primary"> {{index + 1}}</span></td>
                        <td>
                        <input v-model="item.namaPenuh" placeholder="Nama Penuh" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.telefon" placeholder="No Telefon" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.noKP" placeholder="No KP" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.noPekerja" placeholder="No Pekerja" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.noKWSP" placeholder="No KWSP/KWAP" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.tarafJawatan" placeholder="Taraf Jawatan" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.kumpulanJawatan" placeholder="Kumpulan Jawatan" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.kategoriPermainan" placeholder="Kategori Jawatan" class="form-control-sm">
                        </td>
                        <td>
                        <input v-model="item.gredJawatan" placeholder="Gred Jawatan" class="form-control-sm">
                        </td>
                        </tr>
                        </table>
                        <span class="small text-secondary" style="margin-left:34px">Lampiran:</span>
                        <table>
                        <tr>
                        <td style="width:34px"></td>
                        <td>
                        <button class="btn btn-sm btn-outline-dark" @@click="openDialog('Gambar Passport', item,
                        'fileGambar', '.jpg')">Gambar Passport <span v-if="item.fileGambar" class="fa-solid
                        fa-check"></span></button>
                        </td>
                        <td>
                        <button class="btn btn-sm btn-outline-dark" @@click="openDialog('Kad Pengenalan', item,
                        'fileKP', '.jpg')">Kad Pengenalan <span v-if="item.fileKP" class="fa-solid
                        fa-check"></span></button>
                        </td>
                        <td>
                        <button class="btn btn-sm btn-outline-dark" @@click="openDialog('KWSP/KWAP Majikan', item,
                        'fileKWSP', '.pdf,.jpg')">KWSP/KWAP Majikan <span v-if="item.fileKWSP" class="fa-solid
                        fa-check"></span></button>
                        </td>
                        <td>
                        <button class="btn btn-sm btn-outline-dark" @@click="openDialog('Surat Pengesahan Majikan',
                        item, 'fileMajikan', '.pdf,.jpg')">Pengesahan Majikan <span v-if="item.fileMajikan"
                        class="fa-solid fa-check"></span></button>
                        </td>
                        <td>
                        <button class="btn btn-sm btn-outline-dark" @@click="openDialog('Surat Lantikan Pengarah & SSM',
                        item, 'fileSuratPerlantikan', '.pdf,.jpg')">Lembaga Pengarah & SSM <span
                        v-if="item.fileSuratLantikan" class="fa-solid fa-check"></span></button>
                        </td>
                        </tr>
                        </table> *@
                        <partial name="_Editable"></partial>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <span class="tiny text-secondary">Hanya 1) Nama Penuh, 2) No KP, 3) Telefon, 4) Lampiran Gambar dan 5) Kad Pengenalan adalah wajib</span>
    <div class="card mb-3">
        <div class="card-header">
            <span class="fa-solid fa-person-chalkboard"></span> <span class="text-primary">Jurulatih</span>
        </div>
        <div class="card-body">
            <div class="row" v-for="(item, index) in getJurulatih">
                <div class="col">
                    <div class="table-responsive">

                        <partial name="_Editable"></partial>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <span class="tiny text-secondary">Semua adalah wajib kecuali 1) Kategori Permainan, 2) Status Pemain dan 3) Lampiran Surat Pengarah SSM</span>
    <div class="card mb-3">
        <div class="card-header">
            <span class="fa-solid fa-user-doctor"></span> <span class="text-primary">Fisio</span>
        </div>
        <div class="card-body">
            <div class="row" v-for="(item, index) in getFisio">
                <div class="col">
                    <div class="table-responsive">

                        <partial name="_Editable"></partial>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <span class="tiny text-secondary">Semua adalah wajib kecuali 1) Lampiran Surat Pengarah SSM</span>
    <div class="card">
        <div class="card-header">
            <span class="fa-solid fa-people-group"></span> <span class="text-primary">Pemain</span>
        </div>
        <div class="card-body">
            <div class="row" v-for="(item, index) in getPemain">
                <div class="col">
                    <div class="table-responsive">

                        <partial name="_Editable"></partial>
                        <br>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!--  Upload Dialog -->
    <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadModalLabel">{{selectedUploadDialogHeader}}</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="file" class="form-control" @@change="handleFileChange(selectedRecord)"
                        :accept="selectedUploadDialogExtension">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" @@click="uploadFile()">Upload</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Upload Dialog -->

    <!--  Dropdown Selection Dialog -->
    <div class="modal fade" id="choiceModal" tabindex="-1" aria-labelledby="choiceModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="choiceModalLabel">Pilih</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div v-if="IsSelectionMultiple">
                        <div v-for="item in selection">
                            <input type="checkbox" :id="item" :value="item" v-model="selectedSelection">
                            <label :for="item">{{item}}</label>
                        </div>
                    </div>
                    <div v-else>
                        <div v-for="item in selection">
                            <input type="radio" :id="item" :value="item" v-model="selectedSelection">
                            <label :for="item">{{item}}</label>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary btn-sm"
                        @@click="closeChoiceDialog()">Terima</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Dropdown Selection Dialog -->



</div>

@section Scripts {
    <script>
        const { createApp, ref } = Vue;        
        const app = createApp({
            el: '#app',
            data() {
                return  {
                    record: [],
                    activeUploadFile: '',
                    selectedUploadDialogHeader: '',
                    selectedSukan: 'Pilih Sukan',
                    selectedRecord: {},
                    selectedColumn: '',
                    selectedUploadDialogExtension: '',
                    selectionKategoriPermainan: [],
                    selection: [],
                    selectedSelection: [],
                    IsSelectionMultiple: false
                }
            },
            mounted() {

            },
            computed: {
                getPengurus: function () {
                    return this.record.filter(x => x.jenisAhli.toLocaleLowerCase() === 'pengurus');
                },

                getJurulatih: function () {
                    return this.record.filter(x => x.jenisAhli.toLocaleLowerCase() === 'jurulatih');
                },

                getFisio: function () {
                    return this.record.filter(x => x.jenisAhli.toLocaleLowerCase() === 'fisio');
                },

                getPemain: function () {
                    return this.record.filter(x => x.jenisAhli.toLocaleLowerCase() === 'pemain');
                }
            },
            methods: {
                getData: function () {
                    $.ajax({
                        url: '@Url.Content("~/Pasukan/GetPasukan")',
                        type: 'GET',
                        data: { jenisSukan: app.selectedSukan },
                        success: function (data) {
                            app.record = data.pasukan;
                            app.selectionKategoriPermainan = data.kategori;
                        },
                        error: function (error) {
                            app.record = [];
                            toastr.error('Data gagal dimuatkan');
                        }
                    });
                },

                openDialog: function (headerText, record, target, extension) {
                    app.selectedUploadDialogHeader = headerText;
                    app.selectedRecord = record;
                    app.selectedColumn = target;
                    app.selectedUploadDialogExtension = extension;

                    $('#uploadModal').modal('show');
                },

                simpan: function () {

                    if (confirm('Adakah anda pasti untuk mengemaskini kesemua rekod untuk sukan ini?')) {

                        $.ajax({
                            url: '@Url.Content("~/Pasukan/SetPasukan")',
                            type: 'POST',
                            data: { data: app.record },
                            success: function (data) {
                                if (data.status == true) {
                                    toastr.success('Data berjaya disimpan');
                                }
                                else {
                                    toastr.error('Data gagal disimpan');
                                }
                            },
                            error: function (error) {
                                toastr.error('Data gagal disimpan');
                            }
                        });
                    }
                },

                handleFileChange(index) {
                    app.activeUploadFile = event.target.files[0];
                },

                uploadFile: function () {

                    app.selectedRecord[app.selectedColumn] = app.activeUploadFile.name;
                    console.log(app.selectedRecord);

                    var formData = new FormData();
                    formData.append('file', app.activeUploadFile);
                    formData.append('data', JSON.stringify(app.selectedRecord));

                    $.ajax({
                        url: '@Url.Content("~/Pasukan/UploadFile")',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            if (data.status == true) {
                                toastr.warning('Jangan lupa klik butang "simpan" di atas, untuk menyimpan perubahan yang dibuat');
                                $('#uploadModal').modal('hide');
                            }
                            else {
                                toastr.error('Fail gagal dimuat naik');

                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                IsEmpty: function (value) {
                    if (value == null || value == undefined || value == '') {
                        return true;
                    }
                    else {
                        return false;
                    }
                },

                padam: function () {
                    if (confirm('Adakah anda pasti untuk memadam kesemua rekod untuk sukan ini?')) {

                        $.ajax({
                            url: '@Url.Content("~/Pasukan/DelPasukan")',
                            type: 'POST',
                            data: { data: app.record },
                            success: function (data) {
                                if (data.status == true) {
                                    toastr.success('Data berjaya dipadam');
                                    app.record=[];
                                    app.selectedSukan='Pilih Sukan';

                                }
                                else {
                                    toastr.error('Data gagal dipadam');
                                }
                            },
                            error: function (error) {
                                toastr.error('Data gagal dipadam');
                            }
                        });
                    }
                },

                openChoiceDialog: function (choiceList, record, target, isMultiple) {
                    app.IsSelectionMultiple = isMultiple;
                    app.selectedRecord = record;
                    app.selectedColumn = target;
                    app.selection = choiceList;

                    //remove any string from selectedSelection if does not exist in choiceList
                    
                    if (app.selectedRecord[app.selectedColumn] == null || app.selectedRecord[app.selectedColumn] == undefined || app.selectedRecord[app.selectedColumn] == '')
                        app.selectedSelection = [];                    
                    else
                        app.selectedSelection = isMultiple ? app.selectedRecord[app.selectedColumn].split(',') : app.selectedRecord[app.selectedColumn];

                    if (isMultiple) {
                        let _temp = [];
                        app.selectedSelection.forEach(function (item) {
                            if (app.selection.includes(item)) {
                                _temp.push(item);
                            }
                        });
                        app.selectedSelection = _temp;
                    }
                    
                    $('#choiceModal').modal('show');
                },

                closeChoiceDialog: function () {
                    console.log(app.selectedSelection);
                    app.selectedRecord[app.selectedColumn] = Array.isArray(app.selectedSelection) ? app.selectedSelection.join(',') : app.selectedSelection;
                    $('#choiceModal').modal('hide');
                }
            },
        }).mount('#app');




    </script>
}