@model IEnumerable<Ahli>

<div id="app">

    <div class="row">
        <div class="col">

            <nav>
                <div class="nav nav-tabs" id="nav-tab" role="tablist">
                    <button class="nav-link active text-dark" id="nav-home-tab" data-bs-toggle="tab"
                        data-bs-target="#nav-home" type="button" role="tab" aria-controls="nav-home"
                        aria-selected="true">Administration</button>

                    <button class="nav-link text-dark" id="nav-user-tab" data-bs-toggle="tab"
                        data-bs-target="#nav-user" type="button" role="tab" aria-controls="nav-user"
                        aria-selected="true">Pengguna Berdaftar</button>
                    
                    <button class="nav-link text-dark" id="nav-setup-tab" data-bs-toggle="tab"
                        data-bs-target="#nav-setup" type="button" role="tab" aria-controls="nav-setup"
                        aria-selected="true">Tetapan</button>

                </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
                <div class="tab-pane fade show active" id="nav-home" role="tabpanel" aria-labelledby="nav-home-tab">
                    <div class="p-2 mt-3">
                        @foreach (var Agensi in ViewBag.Agencies)
                        {
                            var _ListOfSukan = Model.Where(x => x.Agensi == Agensi.Name).ToList();
                            var _DistinctSukan = _ListOfSukan.Select(x => x.JenisSukan).Distinct().ToList();

                            <div class="card mb-3">
                                <div class="card-header">
                                    <div class="row">
                                        <div class="col">
                                            <span class="fa-solid fa-chevron-down"></span> <strong class="text-primary">@Agensi.Name </strong> ( Jumlah Yuran: RM @Agensi.Fee.ToString("#,#00.00"))
                                        </div>
                                        <div class="col-auto">                                            
                                            <div class="btn-group">
                                                <button type="button" class="btn btn-outline-dark btn-sm dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
                                                    Buka Lampiran
                                                </button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" target="_blank"  href="~/uploads/@Agensi.Name/@Agensi.FileYuran">Bayaran Yuran</a></li>
                                                    <li><a class="dropdown-item" target="_blank"  href="~/uploads/@Agensi.Name/@Agensi.FileResit">Resit Resmi</a></li>                                                
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-8">
                                            @foreach (var Sukan in _DistinctSukan.OrderBy(x =>x))
                                            {
                                                var JenisSukan = Sukan.Replace(" ", "");

                                                <div class="accordion accordion-flush" id="accordionFlushExample">
                                                    <div class="accordion-item">
                                                        <h2 class="accordion-header" id="flush-@JenisSukan">
                                                            <div class="row">
                                                                <div class="col">
                                                                    <button class="accordion-button collapsed" type="button"
                                                                        data-bs-toggle="collapse"
                                                                        data-bs-target="#flush-collapse-@JenisSukan" aria-expanded="false"
                                                                        aria-controls="flush-collapse-@JenisSukan">
                                                                        <span class="small">@Sukan</span>
                                                                    </button>
                                                                </div>
                                                                <div class="col-auto">                                                                    
                                                                    <a target="_blank" class="btn btn-sm btn-outline-dark" asp-controller="Pasukan" asp-action="Cetak" asp-route-sukan="@Sukan" title="Cetak"><span class="fa-solid fa-print"></span> </a>
                                                                </div>
                                                            </div>
                                                           
                                                            
                                                        </h2>

                                                        <div id="flush-collapse-@JenisSukan" class="accordion-collapse collapse"
                                                            aria-labelledby="flush-@JenisSukan"
                                                            data-bs-parent="#accordionFlushExample">
                                                            <div class="accordion-body">
                                                                <div class="table-responsive">
                                                                    <table class="table table-sm" style="font-size:9pt">
                                                                        <tr>
                                                                            <td></td>
                                                                            <td>Nama Penuh</td>
                                                                            <td>No KP</td>
                                                                            <td>No Pekerja</td>
                                                                            <td>No KWSP</td>
                                                                            <td>Taraf J.</td>
                                                                            <td>Kumpulan J.</td>
                                                                            <td>Gred J.</td>
                                                                            <td>Kategori Pemain</td>
                                                                            <td>Gambar</td>
                                                                            <td>KP</td>
                                                                            <td>KWSP</td>
                                                                            <td>Majikan</td>
                                                                            <td>Pengarah / SSM</td>
                                                                        </tr>
                                                                        @foreach(var Ahli in _ListOfSukan.Where(x => x.JenisSukan == Sukan))
                                                                        {
                                                                            <tr>
                                                                                <td>@Ahli.JenisAhli</td>
                                                                                <td>@Ahli.NamaPenuh</td>
                                                                                <td>@Ahli.NoKP</td>
                                                                                <td>@Ahli.NoPekerja</td>
                                                                                <td>@Ahli.NoKWSP</td>
                                                                                <td>@Ahli.TarafJawatan</td>
                                                                                <td>@Ahli.KumpulanJawatan</td>
                                                                                <td>@Ahli.GredJawatan</td>
                                                                                <td>@Ahli.KategoriPermainan</td>
                                                                                <td><a target="_blank" href="~/uploads/@Ahli.Id/@Ahli.FileGambar" 
                                                                                data-bs-toggle="tooltip" data-bs-html="true" title="<img src='@Url.Content("~/uploads/" + @Ahli.Id + "/" + @Ahli.FileGambar)' class='img-fluid'>" >@Ahli.FileGambar</a></td>
                                                                                <td><a target="_blank" href="~/uploads/@Ahli.Id/@Ahli.FileKP"
                                                                                data-bs-toggle="tooltip" data-bs-html="true" title="<img src='@Url.Content("~/uploads/" + @Ahli.Id + "/" + @Ahli.FileKP)' class='img-fluid'>">@Ahli.FileKP</a></td>
                                                                                <td><a target="_blank" href="~/uploads/@Ahli.Id/@Ahli.FileKWSP"
                                                                                data-bs-toggle="tooltip" data-bs-html="true" title="<img src='@Url.Content("~/uploads/" + @Ahli.Id + "/" + @Ahli.FileKWSP)' class='img-fluid'>">@Ahli.FileKWSP</a></td>
                                                                                <td><a target="_blank" href="~/uploads/@Ahli.Id/@Ahli.FileMajikan"
                                                                                data-bs-toggle="tooltip" data-bs-html="true" title="<img src='@Url.Content("~/uploads/" + @Ahli.Id + "/" + @Ahli.FileMajikan)' class='img-fluid'>">@Ahli.FileMajikan</a></td>
                                                                                <td><a target="_blank" href="~/uploads/@Ahli.Id/@Ahli.FileSuratLantikan"
                                                                                data-bs-toggle="tooltip" data-bs-html="true" title="<img src='@Url.Content("~/uploads/" + @Ahli.Id + "/" + @Ahli.FileSuratLantikan)' class='img-fluid'>">@Ahli.FileSuratLantikan</a></td>
                                                                            </tr>
                                                                        }
                                                                    
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                        <div class="col-4">
                                            <!-- PREVIEW RECEIPT IN PDF OR JPEG -->
                                            <div class="row mb-1 small">
                                                <div class="col">
                                                    <span class="fa-solid fa-chevron-down"></span> Bayaran Yuran: <strong> @Agensi.TarikhHantar</strong>
                                                </div>
                                                <div class="col-auto">                                                    
                                                    
                                                </div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col">

                                                    @if (Agensi.FileYuran != null && Agensi.FileYuran.EndsWith(".pdf"))
                                                    {
                                                        <embed src="~/uploads/@Agensi.Name/@Agensi.FileYuran" width="100%" height="200px" />                                            
                                                    }
                                                    else
                                                    {                                                         
                                                        <div style="display: d-flex; overflow:auto; max-height:200px; max-width:100%">
                                                            <img src="~/uploads/@Agensi.Name/@Agensi.FileYuran" style="" >                                                
                                                        </div>                                            
                                                    }
                                            
                                                </div>
                                            </div>
                                            <span class="small"><span class="fa-solid fa-chevron-down"></span> Resit Rasmi:  <strong> @Agensi.TarikhResit</strong></span>
                                            <div class="border p-2 rounded">
                                            <div class="row">
                                                <div class="col">
                                                    <input type="file" class="form-control" accept=".pdf,.jpg" @@change="handleFileChange('@Agensi.Name')">
                                                </div>                                                
                                            </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <div class="tab-pane fade" id="nav-user" role="tabpanel" aria-labelledby="nav-user-tab">
                    <div class="p-2 mt-3">
                        <div class="card">
                            <div class="card-header">
                                Senarai Pengguna Berdaftar
                            </div>
                            <div class="card-body">
                                <table class="table table-sm small">
                                    <tr>
                                        <th>Agensi</th>
                                        <th>Nama Penuh</th>
                                        <th>Emel</th>
                                        <th>Telefon</th>
                                        <th>Jawatan</th>
                                        <th></td>
                                    </tr>
                                    <tr v-for="item in pengguna">
                                        <td><strong class="text-primary">{{item.agensi}}</strong></td>
                                        <td>{{item.namaPenuh}}</td>
                                        <td>{{item.emel}}</td>
                                        <td>{{item.telefon}}</td>
                                        <td>{{item.jawatan}}</td>
                                        <td>
                                            <button class="btn btn-sm btn-danger" @@click="padamPengguna(item.agensi)" :disabled="item.agensi=='Administrator'" ><span class="fa-solid fa-trash"></span></button>
                                        </td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                       
                    </div>
                </div>

                <div class="tab-pane fade" id="nav-setup" role="tabpanel" aria-labelledby="nav-setup-tab">
                    <div class="p-2 mt-3">
                        <div class="card mb-3">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col">
                                        Tarikh Tutup
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-outline-success" @@click="simpanTarikhTutup()">Simpan</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">
                                <input type="date" class="form-control=sm" v-model="tarikhTutup">
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-header">
                                <div class="row">
                                    <div class="col">
                                        Setup Sukan
                                    </div>
                                    <div class="col-auto">
                                        <button class="btn btn-sm btn-outline-success" @@click="simpanSukan()">Simpan</button>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body">                            
                                <table class="table table-sm small">                           
                                    <tr>
                                        <th>Nama Sukan</th>
                                        <th>Yuran (RM)</th>
                                        <th>
                                            <span class="fa-solid fa-exclamation-circle text-secondary"></span> Kategori
                                            <br/>
                                            <span class="tiny">Gunakan comma "," sebagai delimiter</span>
                                        </th>
                                        <th>                                    
                                            <span class="fa-solid  fa-user-tie text-secondary"></span> Bil. Pengurus
                                        </th>
                                        <th><span class="fa-solid fa-person-chalkboard  text-secondary"></span> Bil. Jurulatih</th>
                                        <th><span class="fa-solid fa-user-doctor text-secondary"></span> Bil. Fisio</th>
                                        <th><span class="fa-solid fa-people-group text-secondary"></span> Bil. Pemain</th>
                                    </tr>
                                    <tr v-for="item in sukan">
                                        <td><input type="text" v-model="item.nama" class="form-control"/></td>
                                        <td><input type="number" v-model="item.fee" class="form-control"/></td>
                                        <td><input type="text" v-model="item.kategori" class="form-control"/></td>
                                        <td><input type="number" v-model="item.konfigurasi.Pengurus" class="form-control"/></td>
                                        <td><input type="number" v-model="item.konfigurasi.Jurulatih" class="form-control"/></td>
                                        <td><input type="number" v-model="item.konfigurasi.Fisio" class="form-control"/></td>
                                        <td><input type="number" v-model="item.konfigurasi.Pemain" class="form-control"/></td>                                
                                    </tr>
                                </table>
                            </div>
                        </div>

                        
                    </div>
                </div>

            </div>
        </div>
    </div>
    

    <!-- Modal -->
    <div class="modal fade" id="TukarKataLaluanModal" tabindex="-1" aria-labelledby="TukarKataLaluanModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="TukarKataLaluanModalLabel">Tukar Kata Laluan</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="form-group mb-3">
                        <input type="password" class="form-control" v-model="KataLaluanLama" placeholder="Kata Laluan Lama">
                    </div>
                    <div class="form-group mb-2">
                        <input type="password" class="form-control" v-model="KataLaluanBaru" placeholder="Kata Laluan Baru">
                    </div>
                    <div class="form-group mb-2">                        
                        <input type="password" class="form-control" v-model="KataLaluanConfirm" placeholder="Kata Laluan Baru">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-secondary btn-sm" data-bs-dismiss="modal">Tutup</button>
                    <button type="button" class="btn btn-outline-primary btn-sm" 
                        :disabled="(KataLaluanLama=='' || KataLaluanBaru=='') || KataLaluanBaru != KataLaluanConfirm"
                        @@click="tukarKataLaluan()"
                    >Simpan</button>
                </div>
            </div>
        </div>
    </div>

</div>


@section Scripts{
    <script>
        $(document).ready(function () {
            $('[data-bs-toggle="tooltip"]').tooltip();
        });
    
         var app = new Vue({
            el: '#app',
            data: {
                KataLaluanLama: '',
                KataLaluanBaru: '',
                KataLaluanConfirm: '',
                pengguna:[],
                sukan:[],
                tarikhTutup: '',
                TempResit: '',
            },
            computed: {
            },
            mounted() { 
                this.getPengguna(); 
                this.getSukan();   
                this.getTarikhTutup();          
            },
            methods: {
                tukarKataLaluan: function () {
                    $.ajax({
                        url: '@Url.Content("~/Home/TukarKataLaluan")',
                        type: 'POST',
                        data: {
                            KataLaluanLama: app.KataLaluanLama,
                            KataLaluanBaru: app.KataLaluanBaru
                        },
                        success: function (data) {
                            if (data.status == true) {
                                toastr.success('Kata laluan berjaya ditukar');
                                $('#TukarKataLaluanModal').modal('hide');
                            }
                            else {
                                toastr.error('Kata laluan gagal ditukar. Pastikan kata laluan lama betul');
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                showTukarKataLaluan: function () {
                    $('#TukarKataLaluanModal').modal('show');
                },

                getPengguna: function () {
                    $.ajax({
                        url: '@Url.Content("~/Admin/GetPengguna")',
                        type: 'GET',
                        success: function (data) {
                            app.pengguna = data;
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                padamPengguna: function(agensi) {

                    if (confirm('Adakah anda pasti untuk memadam pengguna ini?')) {
                        $.ajax({
                            url: '@Url.Content("~/Admin/PadamPengguna")',
                            type: 'POST',
                            data: {
                                Agensi: agensi
                            },
                            success: function (data) {
                                if (data.status == true) {
                                    toastr.success('Pengguna berjaya dipadam');
                                    app.getPengguna();
                                }
                                else {
                                    toastr.error('Pengguna gagal dipadam');
                                }
                            },
                            error: function (error) {
                                console.log(error);
                            }
                        });
                    }
                },

                getSukan: function () {
                    $.ajax({
                        url: '@Url.Content("~/Admin/GetSukan")',
                        type: 'GET',
                        success: function (data) {
                            app.sukan = data;
                            app.sukan.forEach(function (item) {
                                item.konfigurasi = JSON.parse(item.konfigurasi);
                            });
                            console.log(app.sukan);
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                simpanSukan: function() {

                    app.sukan.forEach(function (item) {
                        item.konfigurasi = JSON.stringify(item.konfigurasi);
                    });

                    $.ajax({
                        url: '@Url.Content("~/Admin/SimpanSukan")',
                        type: 'POST',
                        data: {
                            Sukan: app.sukan
                        },
                        success: function (data) {
                            if (data.status == true) {
                                toastr.success('Konfigurasi sukan berjaya disimpan');
                                app.getSukan();
                            }
                            else {
                                toastr.error('Konfigurasi sukan gagal disimpan');
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                getTarikhTutup: function() {
                    $.ajax({
                        url: '@Url.Content("~/Admin/GetTarikhTutup")',
                        type: 'GET',
                        success: function (data) {
                            app.tarikhTutup = data;
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                simpanTarikhTutup: function() {
                    $.ajax({
                        url: '@Url.Content("~/Admin/SimpanTarikhTutup")',
                        type: 'POST',
                        data: {
                            TarikhTutup: app.tarikhTutup
                        },
                        success: function (data) {
                            if (data.status == true) {
                                toastr.success('Tarikh tutup berjaya disimpan');
                                app.getTarikhTutup();
                            }
                            else {
                                toastr.error('Tarikh tutup gagal disimpan');
                            }
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },

                handleFileChange(agensi) {
                    app.TempResit = event.target.files[0];
                    app.uploadResit(agensi);
                },

                uploadResit: function (agensi) {

                    console.log(agensi);

                    var formData = new FormData();
                    formData.append('file', app.TempResit);
                    formData.append('agensi', agensi);

                    $.ajax({
                        url: '@Url.Content("~/Admin/UploadResit")',
                        type: 'POST',
                        data: formData,
                        contentType: false,
                        processData: false,
                        success: function (data) {
                            if (data.status == true) {
                                toastr.success('Resit berjaya dimuat naik');                                                           
                            }
                            else {
                                toastr.error('Fail gagal dimuat naik');
                            }

                            app.TempResit = '';
                        },
                        error: function (error) {
                            console.log(error);
                        }
                    });
                },


                
            },

        })
    
    
    </script>


}
